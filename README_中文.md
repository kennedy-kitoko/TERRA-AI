
![å›¾ç‰‡æè¿°](terra.png)

# ğŸŒ± å…³äº TerraSoil

**TerraSoil** æ˜¯ä¸€ä¸ªç®€åŒ–çš„ Arduino/ESP32 åº“ï¼Œæ—¨åœ¨å°†å¤æ‚çš„å·¥ä¸šä¼ æ„Ÿå™¨è½¬å˜ä¸ºæ˜“äºä½¿ç”¨çš„ç›‘æµ‹å·¥å…·ã€‚å®ƒæ˜¯ä¸“ä¸ºä½¿ç”¨ **RS485 Modbus RTU** é€šä¿¡åè®®çš„ "10åˆ1" åœŸå£¤ä¼ æ„Ÿå™¨å¼€å‘çš„ã€‚

## â“ TerraSoil æ˜¯ä»€ä¹ˆï¼Ÿ

é€šå¸¸ï¼Œè¯»å–å·¥ä¸šä¼ æ„Ÿå™¨éœ€è¦å¤„ç†åå…­è¿›åˆ¶ä»£ç ã€è®¡ç®—å¤æ‚çš„æ ¡éªŒå’Œï¼ˆCRCï¼‰ä»¥åŠæ‰‹åŠ¨ç®¡ç† RS485 æ€»çº¿æ—¶åºã€‚

**TerraSoil ä¸ºæ‚¨å¤„ç†æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚** å®ƒæ˜¯ä¸€ä¸ª"è½¯ä»¶å±‚"ï¼Œåœ¨ç¡¬ä»¶å’Œæ‚¨çš„åº”ç”¨ç¨‹åºä¹‹é—´æ¶èµ·æ¡¥æ¢ã€‚

### TerraSoil è‡ªåŠ¨å¤„ç†çš„å†…å®¹ï¼š

1.  **RS485 æ§åˆ¶ï¼š** å®ƒæ§åˆ¶æ–¹å‘å¼•è„šï¼ˆDE/REï¼‰ï¼Œä»¥ä¾¿ ESP32 çŸ¥é“ä½•æ—¶å‘é€å’Œä½•æ—¶æ¥æ”¶ã€‚
2.  **Modbus è§£ç ï¼š** å®ƒæŸ¥è¯¢ä¼ æ„Ÿå™¨çš„ 10 ä¸ªå†…éƒ¨å¯„å­˜å™¨ï¼ˆåœ¨ NPKV2 æ‰‹å†Œä¸­å®šä¹‰ï¼‰ï¼Œå¹¶å°†åŸå§‹å­—èŠ‚è½¬æ¢ä¸ºå®æ•°ï¼ˆæµ®ç‚¹æ•°/æ•´æ•°ï¼‰ã€‚
3.  **CRC å®‰å…¨æ£€æŸ¥ï¼š** å®ƒéªŒè¯æ¥æ”¶çš„æ¯ä¸ªæ•°æ®æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœè¿æ¥çº¿æ¥è§¦ä¸è‰¯æˆ–å­˜åœ¨å¹²æ‰°ï¼Œå®ƒä¼šæ£€æµ‹åˆ°ã€‚
4.  **æ•°æ®ç»Ÿä¸€ï¼š** å®ƒå°† 10 ä¸ªå‚æ•°ï¼ˆæ¹¿åº¦ã€æ¸©åº¦ã€pHã€æ°®ã€ç£·ã€é’¾ã€ç”µå¯¼ç‡ã€ç›åº¦ã€æ€»æº¶è§£å›ºä½“ã€è‚¥åŠ›ï¼‰ç»„åˆæˆä¸€ä¸ªæ˜“äºä½¿ç”¨çš„å•ä¸€ç»“æ„ä½“ã€‚

---

## ğŸ¯ ä¸ºä»€ä¹ˆä½¿ç”¨è¿™ä¸ªåº“ï¼Ÿ

*   **èŠ‚çœæ—¶é—´ï¼š** é€šå¸¸éœ€è¦ 200 è¡Œä»£ç å®Œæˆçš„å·¥ä½œï¼Œåœ¨è¿™é‡Œåªéœ€**ä¸€ä¸ªå‡½æ•°**ï¼š`sensor.readSensor(data)`ã€‚
*   **å‡†ç¡®æ€§ï¼š** å®ƒé›†æˆäº†è´Ÿæ¸©åº¦å’Œ pH å€¼å°æ•°ç‚¹çš„è½¬æ¢è®¡ç®—ã€‚
*   **å…¼å®¹æ€§ï¼š** é’ˆå¯¹ **ESP32-S3**ï¼ˆå¦‚ Seeed Studio XIAOï¼‰è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½†ä¸æ•´ä¸ª ESP32 ç³»åˆ—å…¼å®¹ã€‚
*   **JSON æ ¼å¼ï¼š** é€‚åˆè¿æ¥ï¼ˆIoTï¼‰é¡¹ç›®ï¼Œæ•°æ®å·²å‡†å¤‡å°±ç»ªï¼Œå¯å‘é€åˆ°æœåŠ¡å™¨æˆ–ä»ªè¡¨æ¿ã€‚

---

## ğŸ”Œ å·¥ä½œåŸç†ï¼ˆç¡¬ä»¶ï¼‰

TerraSoil ä½¿ç”¨ RS485 æ ‡å‡†çš„ **ç”µè·¯ B**[é“¾æ¥](https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/peripherals/uart.html)ã€‚æ‚¨éœ€è¦åœ¨å¾®æ§åˆ¶å™¨å’Œä¼ æ„Ÿå™¨ä¹‹é—´ä½¿ç”¨ä¸€ä¸ªå°å‹é€‚é…å™¨æ¨¡å—ï¼ˆTTL è½¬ RS485ï¼‰ã€‚

*   **ESP32** â†’ å‘é€å‘½ä»¤ï¼ˆTX/RX/RTSï¼‰ã€‚
*   **RS485 é€‚é…å™¨** â†’ ä¸ºä¼ æ„Ÿå™¨è½¬æ¢ä¿¡å·ã€‚
*   **TerraSoil ä¼ æ„Ÿå™¨** â†’ é€šè¿‡å…¶ 5 ä¸ªé’¢é’ˆæµ‹é‡åœŸå£¤å‚æ•°ã€‚

---

## ğŸš€ æ€»ç»“

å¦‚æœæ‚¨æƒ³åˆ›å»ºä¸€ä¸ª**å†œä¸šæ°”è±¡ç«™**ã€ä¸€ä¸ª**æ™ºèƒ½è‡ªåŠ¨çŒæº‰ç³»ç»Ÿ**æˆ–ä¸€ä¸ª**è”ç½‘åœŸå£¤ç ”ç©¶**ï¼ŒTerraSoil å°±æ˜¯è®©æŠ€æœ¯éƒ¨åˆ†éšå½¢ï¼Œè®©æ‚¨ä¸“æ³¨äºæ•°æ®çš„å·¥å…·ã€‚

![å›¾ç‰‡æè¿°](SCHEMA.png)

# ğŸ“¦ å®‰è£…æŒ‡å— - TerraSoil åº“

## ğŸ¯ æ–¹æ³• 1ï¼šé€šè¿‡ ZIP æ–‡ä»¶å®‰è£…ï¼ˆæ¨èï¼‰

### æ­¥éª¤ 1ï¼šä¸‹è½½
ä¸‹è½½ **TerraSoil.zip** æ–‡ä»¶

### æ­¥éª¤ 2ï¼šåœ¨ Arduino IDE ä¸­å®‰è£…
1.  æ‰“å¼€ **Arduino IDE**
2.  èœå•ï¼š**é¡¹ç›®** â†’ **åŠ è½½åº“** â†’ **æ·»åŠ  .ZIP åº“...**
3.  é€‰æ‹© **TerraSoil.zip** æ–‡ä»¶
4.  ç­‰å¾…æ¶ˆæ¯ï¼š"åº“å·²æ·»åŠ åˆ°æ‚¨çš„åº“ä¸­"

### æ­¥éª¤ 3ï¼šéªŒè¯å®‰è£…
1.  èœå•ï¼š**æ–‡ä»¶** â†’ **ç¤ºä¾‹** â†’ **TerraSoil**
2.  æ‚¨åº”è¯¥çœ‹åˆ°ï¼š
    - BasicReading
    - AdvancedReading

âœ… **å®‰è£…å®Œæˆï¼**

---

## ğŸ¯ æ–¹æ³• 2ï¼šæ‰‹åŠ¨å®‰è£…

### å®šä½åº“æ–‡ä»¶å¤¹

**Windowsï¼š**
```
C:\Users\[æ‚¨çš„ç”¨æˆ·å]\Documents\Arduino\libraries\
```

**Macï¼š**
```
/Users/[æ‚¨çš„ç”¨æˆ·å]/Documents/Arduino/libraries/
```

**Linuxï¼š**
```
/home/[æ‚¨çš„ç”¨æˆ·å]/Arduino/libraries/
```

### å®‰è£…
1.  ä»å­˜æ¡£ä¸­è§£å‹ **TerraSoil** æ–‡ä»¶å¤¹
2.  å°†æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶åˆ° `libraries` ç›®å½•
3.  é‡æ–°å¯åŠ¨ Arduino IDE

### é¢„æœŸç»“æ„
```
Arduino/
â””â”€â”€ libraries/
    â””â”€â”€ TerraSoil/
        â”œâ”€â”€ src/
        â”‚   â”œâ”€â”€ TerraSoil.h
        â”‚   â””â”€â”€ TerraSoil.cpp
        â”œâ”€â”€ examples/
        â”‚   â”œâ”€â”€ BasicReading/
        â”‚   â””â”€â”€ AdvancedReading/
        â”œâ”€â”€ library.properties
        â”œâ”€â”€ keywords.txt
        â””â”€â”€ README.md
```

---

## ğŸš€ é¦–æ¬¡æµ‹è¯•

### 1. æ‰“å¼€ç¤ºä¾‹
**æ–‡ä»¶** â†’ **ç¤ºä¾‹** â†’ **TerraSoil** â†’ **BasicReading**

### 2. é…ç½®å¼•è„š
æ£€æŸ¥å¼•è„šæ˜¯å¦ä¸æ‚¨çš„æ¥çº¿åŒ¹é…ï¼š
```cpp
#define RS485_RX_PIN   44  // XIAO ESP32-S3 ä¸Šçš„ D7
#define RS485_TX_PIN   43  // XIAO ESP32-S3 ä¸Šçš„ D6
#define RS485_RTS_PIN  1   // XIAO ESP32-S3 ä¸Šçš„ D1
```

### 3. ç¼–è¯‘å’Œä¸Šä¼ 
1.  é€‰æ‹©å¼€å‘æ¿ï¼š**XIAO ESP32S3**
2.  é€‰æ‹© COM ç«¯å£
3.  ç‚¹å‡» **ä¸Šä¼ **ï¼ˆâœï¼‰

### 4. æ£€æŸ¥è¾“å‡º
æ‰“å¼€ **ä¸²å£ç›‘è§†å™¨**ï¼ˆ115200 æ³¢ç‰¹ç‡ï¼‰

**é¢„æœŸè¾“å‡ºï¼š**
```json
{"hum":65.8,"temp":25.3,"ec":1250,"ph":6.5,"n":85,"p":42,"k":120,"sal":15,"tds":625,"fert":247,"ok":1,"time":5000}
```

---

## ğŸ”§ åœ¨æ‚¨çš„ä»£ç ä¸­ä½¿ç”¨

### æœ€ç®€ä»£ç 
```cpp
#include <TerraSoil.h>

#define RS485_RX_PIN   44
#define RS485_TX_PIN   43
#define RS485_RTS_PIN  1

HardwareSerial RS485Serial(1);
TerraSoil sensor(&RS485Serial, RS485_RTS_PIN);
TerraSoilData data;

void setup() {
  Serial.begin(115200);
  sensor.begin(RS485_RX_PIN, RS485_TX_PIN, 4800);
}

void loop() {
  if (sensor.readSensor(data)) {
    Serial.printf("æ¹¿åº¦: %.1f%% | æ¸©åº¦: %.1fÂ°C | pH: %.1f\n",
                  data.moisture, data.temperature, data.ph);
  }
  delay(5000);
}
```

---

## ğŸ“š å¯ç”¨å‡½æ•°

### ğŸ”· åˆå§‹åŒ–
```cpp
sensor.begin(rxPin, txPin, baudRate)
```

### ğŸ”· å®Œæ•´è¯»å–ï¼ˆä¸»è¦åŠŸèƒ½ï¼‰
```cpp
sensor.readSensor(data)
```
**ä¸€ä¸ªå‡½æ•°**è¯»å–å…¨éƒ¨ **10 ä¸ªå‚æ•°**ï¼

### ğŸ”· é…ç½®
```cpp
sensor.setReadDelay(50);     // è¯»å–é—´éš”å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
sensor.setTimeout(300);      // é€šä¿¡è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
uint8_t addr = sensor.getAddress();  // Modbus åœ°å€
```

### ğŸ”· å•ç‹¬è¯»å–
```cpp
uint16_t value;
sensor.readRegister(TERRASOIL_REG_MOISTURE, value);
```

---

## ğŸ“Š æ•°æ®ç»“æ„

```cpp
TerraSoilData data;

// åœ¨ sensor.readSensor(data) ä¹‹åï¼š
data.moisture      // float    - æ¹¿åº¦ (%)
data.temperature   // float    - æ¸©åº¦ (Â°C)
data.conductivity  // uint16_t - ç”µå¯¼ç‡ (ÂµS/cm)
data.ph            // float    - pH
data.nitrogen      // uint16_t - æ°® (mg/kg)
data.phosphorus    // uint16_t - ç£· (mg/kg)
data.potassium     // uint16_t - é’¾ (mg/kg)
data.salinity      // uint16_t - ç›åº¦
data.tds           // uint16_t - æ€»æº¶è§£å›ºä½“ (mg/L)
data.fertility     // uint16_t - è‚¥åŠ› (mg/kg)
data.success       // bool     - æˆåŠŸåˆ™ä¸º true
data.timestamp     // uint32_t - æ—¶é—´æˆ³ (æ¯«ç§’)
```

---

## â“ æ•…éšœæ’é™¤

### âŒ é”™è¯¯ "TerraSoil.h: No such file"
**è§£å†³æ–¹æ¡ˆï¼š** åº“æœªæ­£ç¡®å®‰è£…
- æ£€æŸ¥åº“æ–‡ä»¶å¤¹
- é‡æ–°å¯åŠ¨ Arduino IDE

### âŒ é”™è¯¯ "readSensor was not declared"
**è§£å†³æ–¹æ¡ˆï¼š** æ–‡ä»¶æœªåŒ…å«åº“
```cpp
#include <TerraSoil.h>  // æ·»åŠ æ­¤è¡Œ
```

### âŒ æ— æ•°æ®ï¼ˆè¶…æ—¶ï¼‰
**è§£å†³æ–¹æ¡ˆï¼š**
1.  æ£€æŸ¥ RS485 è¿æ¥ï¼ˆA æ¥ Aï¼ŒB æ¥ Bï¼‰
2.  æ£€æŸ¥ä¼ æ„Ÿå™¨ 5V ç”µæº
3.  æ£€æŸ¥ DE å’Œ RE æ˜¯å¦è¿æ¥åœ¨ä¸€èµ·

### âŒ æ•°æ®ä¸æ­£ç¡®
**è§£å†³æ–¹æ¡ˆï¼š**
1.  æ£€æŸ¥å…¬å…±åœ°çº¿ï¼ˆæ‰€æœ‰ GND è¿æ¥ï¼‰
2.  æ£€æŸ¥ Modbus åœ°å€ï¼ˆé»˜è®¤ 0x01ï¼‰
3.  æ£€æŸ¥æ³¢ç‰¹ç‡ï¼ˆ4800ï¼‰

---

## ğŸ”— ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šJSON è¾“å‡º
```cpp
if (sensor.readSensor(data)) {
  StaticJsonDocument<256> doc;
  doc["hum"] = data.moisture;
  doc["temp"] = data.temperature;
  doc["ph"] = data.ph;
  serializeJson(doc, Serial);
}
```

### ç¤ºä¾‹ 2ï¼šMQTT
```cpp
if (sensor.readSensor(data)) {
  String payload = String("{\"hum\":") + data.moisture +
                   ",\"temp\":" + data.temperature + "}";
  client.publish("soil/data", payload.c_str());
}
```

### ç¤ºä¾‹ 3ï¼šæŠ¥è­¦é˜ˆå€¼
```cpp
if (sensor.readSensor(data)) {
  if (data.moisture < 30.0) {
    Serial.println("âš ï¸ è­¦æŠ¥ï¼šåœŸå£¤å¤ªå¹²ï¼");
  }
  if (data.ph < 6.0 || data.ph > 7.5) {
    Serial.println("âš ï¸ è­¦æŠ¥ï¼špH å€¼è¶…å‡ºèŒƒå›´ï¼");
  }
}
```

---

## ğŸ“– å®Œæ•´æ–‡æ¡£

æŸ¥çœ‹åº“æ–‡ä»¶å¤¹ä¸­çš„ **README.md** æ–‡ä»¶ä»¥è·å–ï¼š
- å®Œæ•´ API
- Modbus å¯„å­˜å™¨
- è¯¦ç»†æ¥çº¿å›¾
- æ›´å¤šç¤ºä¾‹

---

## âœ… å®‰è£…æ¸…å•

- [ ] å·²ä¸‹è½½ TerraSoil.zip æ–‡ä»¶
- [ ] å·²é€šè¿‡ Arduino IDE æ·»åŠ åº“
- [ ] åœ¨æ–‡ä»¶ â†’ ç¤ºä¾‹èœå•ä¸­å¯ä»¥çœ‹åˆ°ç¤ºä¾‹
- [ ] ä»£ç ç¼–è¯‘æ— é”™è¯¯
- [ ] å·²æ£€æŸ¥ RS485 æ¥çº¿ï¼ˆAã€Bã€DE/REã€ç”µæºï¼‰
- [ ] å…¬å…±åœ°çº¿å·²è¿æ¥
- [ ] ä½¿ç”¨ BasicReading é¦–æ¬¡æµ‹è¯•æˆåŠŸ

---

**ğŸŒ± åº“å·²å®‰è£…ï¼äº«å—ä½¿ç”¨ TerraSoilï¼ ğŸŒ±**
